name: 'Terraform Apply and Summary'
description: 'Applies Terraform plan and writes a grouped resource summary with IDs and timestamp to GitHub Step Summary. Supports AWS, Azure, GCP, and HCP Terraform Cloud backends with built-in authentication.'

inputs:

  # Cloud Provider Selection
  cloud-provider:
    description: "Cloud provider for backend storage. Options: 'aws', 'azure', 'gcp', 'snowflake', 'databricks'"
    required: true
    type: string
  terraform-dir:
    description: "Relative path to the directory containing Terraform configuration files (e.g., 'infra/aws/tf', 'infra/azure/tf', 'infra/gcp/tf')."
    required: false
    type: string
    default: "tf"
  release-tag:
    description: "Git release tag to check out. If omitted, the latest commit on the default branch is used."
    required: false
    type: string
    default: ""
  ci-pipeline:
    description: "Set to 'true' to include the commit SHA in the Terraform state key (suitable for CI/CD). Use 'false' for static state keys."
    required: false
    type: string
    default: "false"

  # Backend Type Selection
  backend-type:
    description: "Backend type to use: 's3' for AWS S3 or 'remote' for HCP Terraform Cloud."
    required: false
    type: string
    default: "s3"

  # AWS S3 Backend Configuration
  s3-bucket:
    description: "Name of the S3 bucket used as the backend for storing the Terraform state file (AWS only)."
    required: false
    type: string

  s3-region:
    description: "AWS region where the S3 backend bucket is located (e.g., us-east-1, eu-west-1) (AWS only)."
    required: false
    type: string

  s3-key-prefix:
    description: "Optional prefix for the S3 state key (AWS only)."
    required: false
    type: string
    default: ""

  # HCP Terraform Cloud Inputs
  tfc-token:
    description: "HCP Terraform Cloud API token. Should be passed as a secret. Required when backend-type is 'remote'."
    required: false
    type: string

  # AWS Authentication Inputs
  aws-region:
    description: "AWS region for authentication. Required when cloud-provider is 'aws'."
    required: false
    type: string

  aws-role-to-assume:
    description: "AWS IAM role ARN to assume. Required when cloud-provider is 'aws'."
    required: false
    type: string

  # GCP Authentication Inputs
  gcp-wif-provider:
    description: "GCP Workload Identity Federation provider. Required when cloud-provider is 'gcp'."
    required: false
    type: string

  gcp-service-account:
    description: "GCP service account email for authentication. Required when cloud-provider is 'gcp'."
    required: false
    type: string

  # Azure Authentication Inputs
  azure-client-id:
    description: "Azure client ID for authentication. Required when cloud-provider is 'azure'."
    required: false
    type: string

  azure-tenant-id:
    description: "Azure tenant ID for authentication. Required when cloud-provider is 'azure'."
    required: false
    type: string

  azure-subscription-id:
    description: "Azure subscription ID for authentication. Required when cloud-provider is 'azure'."
    required: false
    type: string

  # Snowflake Authentication Inputs
  snowflake-account:
    description: "Snowflake account identifier. Required when cloud-provider is 'snowflake'."
    required: false
    type: string

  snowflake-user:
    description: "Snowflake user name. Required when cloud-provider is 'snowflake'."
    required: false
    type: string

  snowflake-role:
    description: "Snowflake role name. Required when cloud-provider is 'snowflake'."
    required: false
    type: string

  snowflake-private-key:
    description: "Snowflake private key for authentication. Required when cloud-provider is 'snowflake'."
    required: false
    type: string

  # Databricks Authentication Inputs
  databricks-host:
    description: "Databricks workspace URL. Required when cloud-provider is 'databricks'."
    required: false
    type: string

  databricks-token:
    description: "Databricks personal access token. Required when cloud-provider is 'databricks'."
    required: false
    type: string

  # Terraform artifacts
  tf-plan-name:
    description: "Name of the Terraform plan file"
    required: false
    default: "terraform-plan"

  tf-plan-file:
    description: "File to save the Terraform plan output"
    required: false
    default: "tfplan"  

  tf-vars-file:
    description: "Optional Terraform variable file"
    required: false
    default: "terraform.tfvars"

runs:
  using: "composite"
  steps:

    # ðŸ“‹ Correct Step Sequence:
    ################################################
    # Debug - Print All Inputs - Debug information
    # Validate Configuration - Input validation
    # Set Checkout Ref - Determine checkout reference
    # Checkout Repo - Get the code
    # Setup Terraform - Install Terraform
    # Download Terraform plan artifact - Get the plan file
    # Configure Cloud Authentication - OIDC authentication (AWS/Azure/GCP/Snowflake/Databricks)
    # Setup TFC Credentials - HCP Terraform Cloud credentials (if remote)
    # Initialize Remote Backend - HCP Terraform Cloud init (if remote)
    # Generate State Key - Create S3 state key (if S3)
    # Initialize S3 Backend - S3 backend init (if S3)
    # Terraform Apply with Summary - Execute the plan

    # Print all inputs for debug
    #############################################
    - name: Debug - Print All Inputs
      id: debug-inputs
      shell: bash
      run: |
        echo "=== DEBUG: All Action Inputs ==="
        echo "backend-type: ${{ inputs.backend-type }}"
        echo "cloud-provider: ${{ inputs.cloud-provider }}"
        echo "terraform-dir: ${{ inputs.terraform-dir }}"
        echo "release-tag: ${{ inputs.release-tag }}"
        echo "ci-pipeline: ${{ inputs.ci-pipeline }}"
        echo "tf-plan-name: ${{ inputs.tf-plan-name }}"
        echo "tf-plan-file: ${{ inputs.tf-plan-file }}"
        echo "tf-vars-file: ${{ inputs.tf-vars-file }}"
        echo ""
        echo "=== AWS S3 Backend Inputs ==="
        echo "s3-bucket: ${{ inputs.s3-bucket }}"
        echo "s3-region: ${{ inputs.s3-region }}"
        echo "s3-key-prefix: ${{ inputs.s3-key-prefix }}"
        echo ""
        echo "=== HCP Terraform Cloud Inputs ==="
        echo "tfc-token: [REDACTED - $(if [[ -n '${{ inputs.tfc-token }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
        echo ""
        echo "=== AWS Authentication Inputs ==="
        echo "aws-region: ${{ inputs.aws-region }}"
        echo "aws-role-to-assume: ${{ inputs.aws-role-to-assume }}"
        echo ""
        echo "=== GCP Authentication Inputs ==="
        echo "gcp-wif-provider: ${{ inputs.gcp-wif-provider }}"
        echo "gcp-service-account: ${{ inputs.gcp-service-account }}"
        echo ""
        echo "=== Azure Authentication Inputs ==="
        echo "azure-client-id: ${{ inputs.azure-client-id }}"
        echo "azure-tenant-id: ${{ inputs.azure-tenant-id }}"
        echo "azure-subscription-id: ${{ inputs.azure-subscription-id }}"
        echo ""
        echo "=== Snowflake Authentication Inputs ==="
        echo "snowflake-account: ${{ inputs.snowflake-account }}"
        echo "snowflake-user: ${{ inputs.snowflake-user }}"
        echo "snowflake-role: ${{ inputs.snowflake-role }}"
        echo "snowflake-private-key: [REDACTED - $(if [[ -n '${{ inputs.snowflake-private-key }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
        echo ""
        echo "=== Databricks Authentication Inputs ==="
        echo "databricks-host: ${{ inputs.databricks-host }}"
        echo "databricks-token: [REDACTED - $(if [[ -n '${{ inputs.databricks-token }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
        echo "================================="

    # Validate input configuration
    #############################################
    - name: Validate Input Configuration
      id: validate-config
      shell: bash
      run: |
        # Validate backend configuration
        if [[ "${{ inputs.backend-type }}" == "s3" ]]; then
          if [[ -z "${{ inputs.s3-bucket }}" || -z "${{ inputs.s3-region }}" ]]; then
            echo "Error: s3-bucket and s3-region are required when backend-type is 's3'"
            exit 1
          fi
        elif [[ "${{ inputs.backend-type }}" == "remote" ]]; then
          if [[ -z "${{ inputs.tfc-token }}" ]]; then
            echo "Error: tfc-token is required when backend-type is 'remote'"
            exit 1
          fi
          echo "Using existing backend configuration from Terraform files"
        else
          echo "Error: backend-type must be either 's3' or 'remote'"
          exit 1
        fi

        # Validate cloud provider configuration
        case "${{ inputs.cloud-provider }}" in
          "aws")
            if [[ -z "${{ inputs.aws-region }}" || -z "${{ inputs.aws-role-to-assume }}" ]]; then
              echo "Error: aws-region and aws-role-to-assume are required when cloud-provider is 'aws'"
              exit 1
            fi
            ;;
          "gcp")
            if [[ -z "${{ inputs.gcp-wif-provider }}" || -z "${{ inputs.gcp-service-account }}" ]]; then
              echo "Error: gcp-wif-provider and gcp-service-account are required when cloud-provider is 'gcp'"
              exit 1
            fi
            ;;
          "azure")
            if [[ -z "${{ inputs.azure-client-id }}" || -z "${{ inputs.azure-tenant-id }}" || -z "${{ inputs.azure-subscription-id }}" ]]; then
              echo "Error: azure-client-id, azure-tenant-id, and azure-subscription-id are required when cloud-provider is 'azure'"
              exit 1
            fi
            ;;
          "snowflake")
            if [[ -z "${{ inputs.snowflake-account }}" || -z "${{ inputs.snowflake-user }}" || -z "${{ inputs.snowflake-role }}" || -z "${{ inputs.snowflake-private-key }}" ]]; then
              echo "Error: snowflake-account, snowflake-user, snowflake-role, and snowflake-private-key are required when cloud-provider is 'snowflake'"
              exit 1
            fi
            ;;
          "databricks")
            if [[ -z "${{ inputs.databricks-host }}" || -z "${{ inputs.databricks-token }}" ]]; then
              echo "Error: databricks-host and databricks-token are required when cloud-provider is 'databricks'"
              exit 1
            fi
            ;;
          *)
            echo "Error: cloud-provider must be 'aws', 'gcp', 'azure', 'snowflake', or 'databricks'"
            exit 1
            ;;
        esac

    # Determine checkout reference
    #############################################
    - name: Set Checkout Ref
      id: set-ref
      shell: bash
      run: |
        if [[ -n "${{ inputs.release-tag }}" ]]; then
          echo "ref=${{ inputs.release-tag }}" >> $GITHUB_OUTPUT
        else
          echo "ref=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
        fi

    # Checkout repo and setup Terraform
    #############################################
    - name: Checkout Repo
      id: checkout
      uses: actions/checkout@v6
      with:
        ref: ${{ steps.set-ref.outputs.ref }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Download Terraform plan artifact
      uses: actions/download-artifact@v7
      with:
        name: ${{ inputs.tf-plan-name }}
        path: ${{ github.workspace }}/${{ inputs.terraform-dir }}

    #  Cloud Provider Authentication (OIDC)
    #############################################    
    - name: Configure AWS Authentication
      if: inputs.cloud-provider == 'aws'
      uses: aws-actions/configure-aws-credentials@v6
      with:
        aws-region: ${{ inputs.aws-region }}
        role-to-assume: ${{ inputs.aws-role-to-assume }}

    - name: Configure Azure Authentication
      if: inputs.cloud-provider == 'azure'
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.azure-subscription-id }}

    - name: Configure GCP Authentication (WIF)
      if: inputs.cloud-provider == 'gcp'
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ inputs.gcp-wif-provider }}
        service_account: ${{ inputs.gcp-service-account }}

    #  Terraform Cloud Backend 
    #############################################
    - name: Setup Terraform Cloud Credentials
      id: setup-tfc-credentials
      if: inputs.backend-type == 'remote'
      shell: bash
      run: |
        mkdir -p ~/.terraform.d
        cat > ~/.terraform.d/credentials.tfrc.json << EOF
        {
          "credentials": {
            "app.terraform.io": {
              "token": "${{ inputs.tfc-token }}"
            }
          }
        }
        EOF

    - name: Initialize Terraform with HCP Terraform Cloud Backend
      id: terraform-init-remote
      if: inputs.backend-type == 'remote'
      shell: bash
      working-directory: ${{ github.workspace }}/${{ inputs.terraform-dir }}
      run: |
        terraform init -input=false

    #  AWS S3 Backend 
    #############################################
    - name: Generate Terraform State Key
      id: generate-tfstate-key
      if: inputs.backend-type == 's3'
      shell: bash
      working-directory: ${{ github.workspace }}/${{ inputs.terraform-dir }}
      run: |
        if [[ "${{ inputs.ci-pipeline }}" == "true" ]]; then
          state_key="${{ github.repository }}/${{ github.sha }}/terraform.tfstate"
        else
          state_key="${{ github.repository }}/terraform.tfstate"
        fi
        echo "state_key=$state_key" >> $GITHUB_OUTPUT

    - name: Initialize Terraform with S3 Backend
      id: terraform-init-s3
      if: inputs.backend-type == 's3'
      shell: bash
      working-directory: ${{ github.workspace }}/${{ inputs.terraform-dir }}
      run: |
        # Build state key with optional prefix
        if [[ -n "${{ inputs.s3-key-prefix }}" ]]; then
          full_key="${{ inputs.s3-key-prefix }}/${{ steps.generate-tfstate-key.outputs.state_key }}"
        else
          full_key="${{ steps.generate-tfstate-key.outputs.state_key }}"
        fi
        
        # Initialize with S3 backend
        terraform init -input=false \
          -backend-config="bucket=${{ inputs.s3-bucket }}" \
          -backend-config="key=$full_key" \
          -backend-config="region=${{ inputs.s3-region }}" \
          -backend-config="encrypt=true" \
          -backend-config="use_lockfile=true"

    # Final step - Terraform apply with summary
    #############################################
    - name: Terraform Apply with Summary
      id: apply
      working-directory: ${{ github.workspace }}/${{ inputs.terraform-dir }}
      shell: bash
      run: |
        
        # Check if the plan file exists
        if [ ! -f tfplan.out ]; then
          echo "âŒ Plan file not found. Exiting."
          exit 1
        fi

        echo "---------Terraform Var file--------------------"
        cat ${{ inputs.tf-vars-file }}

        START_TIME=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
        echo "## ðŸš€ Multi-Cloud Terraform Apply Output" >> "$GITHUB_STEP_SUMMARY"
        echo "_**Backend Type: ${{ inputs.backend-type }}**_" >> "$GITHUB_STEP_SUMMARY"
        if [[ "${{ inputs.backend-type }}" == "s3" ]]; then
          echo "_**Cloud Provider: ${{ inputs.cloud-provider }}**_" >> "$GITHUB_STEP_SUMMARY"
        fi
        echo "_**Started at: ${START_TIME}**_" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        # Display backend configuration info
        echo "### ðŸ”§ Backend Configuration" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        if [[ "${{ inputs.backend-type }}" == "remote" ]]; then
          echo "- **Provider**: HCP Terraform Cloud" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Authentication**: Token-based" >> "$GITHUB_STEP_SUMMARY"
        else
          case "${{ inputs.cloud-provider }}" in
            "aws")
              echo "- **Provider**: Amazon Web Services" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Region**: ${{ inputs.aws-region }}" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Authentication**: IAM Role (${{ inputs.aws-role-to-assume }})" >> "$GITHUB_STEP_SUMMARY"
              ;;
            "azure")
              echo "- **Provider**: Microsoft Azure (Storage Account)" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Authentication**: Service Principal (${{ inputs.azure-client-id }})" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Subscription**: ${{ inputs.azure-subscription-id }}" >> "$GITHUB_STEP_SUMMARY"
              ;;
            "gcp")
              echo "- **Provider**: Google Cloud Platform (Cloud Storage)" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Authentication**: Workload Identity Federation" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Service Account**: ${{ inputs.gcp-service-account }}" >> "$GITHUB_STEP_SUMMARY"
              ;;
            "snowflake")
              echo "- **Provider**: Snowflake" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Account**: ${{ inputs.snowflake-account }}" >> "$GITHUB_STEP_SUMMARY"
              echo "- **User**: ${{ inputs.snowflake-user }}" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Role**: ${{ inputs.snowflake-role }}" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Authentication**: Private Key" >> "$GITHUB_STEP_SUMMARY"
              ;;
            "databricks")
              echo "- **Provider**: Databricks" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Host**: ${{ inputs.databricks-host }}" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Authentication**: Personal Access Token" >> "$GITHUB_STEP_SUMMARY"
              ;;
          esac
        fi
        echo "" >> "$GITHUB_STEP_SUMMARY"

        # Apply the saved plan
        terraform apply -input=false -auto-approve tfplan.out

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ“Œ Affected Resources" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "| Resource Address | Action | Resource Type | Resource Name |" >> "$GITHUB_STEP_SUMMARY"
        echo "|------------------|--------|---------------|----------------|" >> "$GITHUB_STEP_SUMMARY"

        # Parse affected resources from the plan
        terraform show -json tfplan.out | jq -r '
          .resource_changes[] | 
          select(.change.actions != ["no-op"]) |
          "| \(.address) | \(.change.actions[0]) | \(.type) | \(.name) |"
        ' >> "$GITHUB_STEP_SUMMARY"

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ“¤ Terraform Outputs" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        terraform output -json > tf_output.json

        echo "| Name | Value |" >> "$GITHUB_STEP_SUMMARY"
        echo "|------|-------|" >> "$GITHUB_STEP_SUMMARY"

        jq -r 'to_entries[] | 
          "| \(.key) | \(.value.value)"' tf_output.json >> "$GITHUB_STEP_SUMMARY"

        echo "" >> "$GITHUB_STEP_SUMMARY"
        END_TIME=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
        echo "_**Completed at: ${END_TIME}**_" >> "$GITHUB_STEP_SUMMARY"

